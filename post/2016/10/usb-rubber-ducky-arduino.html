<!DOCTYPE html>
<html class="direction--ltr"lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>USB Rubber Ducky con Arduino UNO | kr0no.me</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="USB Rubber Ducky con Arduino UNO" />
<meta name="author" content="Aitor F." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Creación de un teclado virtual malicioso utilizando una placa Arduino UNO." />
<meta property="og:description" content="Creación de un teclado virtual malicioso utilizando una placa Arduino UNO." />
<link rel="canonical" href="https://kr0no.me/post/2016/10/usb-rubber-ducky-arduino" />
<meta property="og:url" content="https://kr0no.me/post/2016/10/usb-rubber-ducky-arduino" />
<meta property="og:site_name" content="kr0no.me" />
<meta property="og:image" content="https://kr0no.me/images/usb-rubber-ducky-arduino/arduino_flash.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-10-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://kr0no.me/images/usb-rubber-ducky-arduino/arduino_flash.png" />
<meta property="twitter:title" content="USB Rubber Ducky con Arduino UNO" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Aitor F."},"description":"Creación de un teclado virtual malicioso utilizando una placa Arduino UNO.","image":"https://kr0no.me/images/usb-rubber-ducky-arduino/arduino_flash.png","url":"https://kr0no.me/post/2016/10/usb-rubber-ducky-arduino","@type":"BlogPosting","headline":"USB Rubber Ducky con Arduino UNO","dateModified":"2016-10-04T00:00:00+00:00","datePublished":"2016-10-04T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kr0no.me/post/2016/10/usb-rubber-ducky-arduino"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/assets/css/magnific-popup.css"><link type="application/atom+xml" rel="alternate" href="https://kr0no.me/feed.xml" title="kr0no.me" /><script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
  <script src="/assets/js/jquery.magnific-popup.js"></script>
</head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">kr0no.me<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        
        
        <a class="color-cyan-hover" href="https://twitter.com/Aitor_FL"><i class="fab fa-twitter-square"></i></a>
        
        
        
        <a class="color-blue-hover" href="https://www.linkedin.com/in/aitorfl/"><i class="fab fa-linkedin"></i></a>
        
        
        
        <a class="color-purple-hover" href="https://github.com/kr0no"><i class="fab fa-github-square"></i></a>
        
        
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">


<img src="
    /images/avatar.jpg
" class="author-avatar" alt="Avatar" />
<div class="description">Aitor Fuentes, a.k.a kr0no.<br /> En mis ratos libres, desarrollo videojuegos y cacharreo con cosas.<br /> Miembro del Red Team de Telefónica Tech.</div>

</div>


<div class="post">
  <h1 class="post-title">USB Rubber Ducky con Arduino UNO</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/infosec/">infosec</a>
      
      <a class="tag" href="/tag/things/">things</a>
      
  </div>
  
  <div class="post-date">Published on 04 Oct 2016</div>
  
  <noscript>
    <div class="post-description">Creación de un teclado virtual malicioso utilizando una placa Arduino UNO.</div>
  </noscript>
  <div id="animated-post-description" class="post-description" style="display: none;"></div>
  
  <p>La placa Arduino UNO, en teoría, no tiene la capacidad para actuar como un dispositivo HID, que es la función que necesitamos para poder crear con ella un USB Rubber Ducky. Sin embargo, esta placa tiene dos microcontroladores Arduino, el ATmega328 y el ATmega16u2, siendo este segundo el que nos interesa. Este microcontrolador se puede reprogramar para que funcione como un USB AVR (tal y como lo haría un Arduino Leonardo, por ejemplo), que es lo que nos permitiría emular un dispositivo HID y así crear nuestro propio USB Rubber Ducky.</p>

<p>Para conseguir esta función adicional tendremos que flashear un nuevo bootloader llamado HoodLoader2, creado por <a href="http://www.nicohood.de/">NicoHood</a>. El código fuente está disponible en su propio <a href="https://github.com/NicoHood/HoodLoader2">Github</a>.</p>

<p>Los pasos para flashear este bootloader empiezan por subir el sketch de instalación al Arduino con el Arduino IDE (podemos descargarlo desde <a href="https://github.com/NicoHood/HoodLoader2/tree/master/avr/examples/Installation_Sketch">aquí</a>), de forma normal y corriente como haríamos con cualquier otro sketch programado por nososotrs mismos. Una vez hecho esto, necesitaremos hacer un pequeño cableado en la placa para así poder flashear el bootloader automáticamente.</p>

<p>El esquema de cableado que necesitamos para esto es el siguiente:</p>

<p><img src="/images/usb-rubber-ducky-arduino/arduino_flash.png" alt="Esquema Arduino" /></p>

<p>Una vez hecho esto, volvemos a conectar el Arduino a un puerto USB, y automáticamente iniciaría el flasheado del nuevo bootloader. Nada más conectarlo el led parpadeará lentamente durante 10 segundos, tras los cuales, empezaría el proceso de flasheo, que durará alrededor de unos 30 segundos, y cuando finalice el mismo led parpadeará rápidamente (cada 100ms).</p>

<p>Si el led sigue parpadeando lentamente (cada segundo) significará que la instalación ha fallado, y volverá a intentar autoflashearse en 10 segundos.</p>

<p>Todo el proceso de instalación de HoodLoader2 lo tenemos mucho más detallado en su propio Github: <a href="https://github.com/NicoHood/HoodLoader2/wiki/Installation-sketch-(standalone-Arduino-Uno-Mega)">https://github.com/NicoHood/HoodLoader2/wiki/Installation-sketch-(standalone-Arduino-Uno-Mega)</a>.</p>

<p>Ahora ya tenemos la placa con el nuevo bootloader, pero el propio Arduino IDE no lo reconocerá y no nos dejará subir nuestros sketches, por lo que necesitaremos instalar las definicones para las placas con HoodLoader2. Es un proceso realmente sencillo y podemos ver los pasos a seguir aquí: <a href="https://github.com/NicoHood/HoodLoader2/wiki/Software-Installation">https://github.com/NicoHood/HoodLoader2/wiki/Software-Installation</a>.</p>

<p>Una vez Arduino IDE nos reconocé la placa, podemos probar a subir un sketch de prueba y comprobar si lo ejecuta correctamente:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="cp">#include "HID-Project.h"
</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Keyboard</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

    <span class="n">Keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="n">KEY_LEFT_GUI</span><span class="p">);</span>
    <span class="n">Keyboard</span><span class="p">.</span><span class="n">press</span><span class="p">(</span><span class="n">KEY_R</span><span class="p">);</span>
    <span class="n">Keyboard</span><span class="p">.</span><span class="n">releaseAll</span><span class="p">();</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Keyboard</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Keyboard</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"calc.exe"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Como se puede observar en la imagen, utilizaremos la librería “<a href="https://github.com/NicoHood/HID">HID-Project</a>”.
Esta librería nos permite utilizar Keyboard.println() para enviar un string seguido de un Enter. Si no quisieramos enviar el Enter final utilizaríamos Keyboard.print().
Si necesitamos enviar una combinación de teclas, podemos simular que estamos presionándolas con el comando Keyboard.press(), y una vez enviada la combinación soltarlas con el comando Keyboard.releaseAll().</p>

<p>Aquí dejo un .txt con todas las KEY_* disponibles con su respectivo código: <a href="/downloads/ducky_keys.txt">downloads/ducky_keys.txt</a></p>

<p>Solo nos queda conectar el Arduino al equipo en el que lo queremos comprobar y esperar. En este caso parece que funciona a la perfección abriendo la calculadora :P</p>

<p><img src="/images/usb-rubber-ducky-arduino/calc.gif" alt="Demo" /></p>

<p>Para poder utilizar los scripts que están diseñados para el USB Rubber Ducky original, he creado un pequeño script que convierte cada función a la función equivalente en Arduino, y genera automáticamente el scketch completo, listo para subirlo a la placa. Es posible que tenga algún fallo, pero los que he comprobado funcionaban a la perfección.</p>

<p>Ducky2Arduino: <a href="https://github.com/kr0no/Ducky2Arduino">https://github.com/kr0no/Ducky2Arduino</a></p>

<p>Como ejemplo sencillo, el script Hello World de Rubber Ducky tendría el siguiente formato en un sketch de Arduino:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">~$</span><span class="w"> </span>ducky2arduino.py helloword_ducky.txt helloword_arduino.txt</code></pre></figure>

<p><img src="/images/usb-rubber-ducky-arduino/ducky2arduino.png" alt="Ducky2Arduino" /></p>

<p>Todo esto ya tiene sus años, pero tenía un Arduino UNO tirado por casa y quería darle algún uso útil. Si a día de hoy queremos hacer esto, tenemos una forma mucho más sencilla haciéndonos directamente con alternativas como Teensy o Arduino Zero, ya que permiten emular de forma nativa y sin ningún problema dispositivos HID.</p>

</div>





<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/post/2017/01/reprogramar-sonoff-switch-mqtt">
            Reprogramando switch Sonoff para MQTT local
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>blog tags</h2>
  <div class="tag-cloud"><a href="/tag/infosec/" class="set-1">infosec</a> <a href="/tag/iot/" class="set-1">iot</a> <a href="/tag/things/" class="set-5">things</a></div>
  




<script>
  let i = 0;
  const text = 'Creación de un teclado virtual malicioso utilizando una placa Arduino UNO.';
  const speed = parseInt('10');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();

  // Image modal
  var $imgs = [];
  $('img').each(function(idx) {
    var obj = {
      src: $(this).attr('src')
    }
    $imgs.push(obj);
    var elem = $(this);
    $(this).click(function() {
      $('.modal').magnificPopup('open', idx);
    });
  });

  $('.modal').magnificPopup({
    items: $imgs,
    type: 'image',
    closeOnContentClick: true,
    mainClass: 'mfp-img-mobile',
    image: {
      verticalFit: true
    }
    
  });
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><a href="https://github.com/bitbrain/jekyll-dash">dash</a> theme for Jekyll by <a href="https://github.com/bitbrain">bitbrain</a> made with <i class="fas fa-heart"></i><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
