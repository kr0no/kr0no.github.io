<!DOCTYPE html>
<html class="direction--ltr"lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Reprogramando switch Sonoff para MQTT local | kr0no.me</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Reprogramando switch Sonoff para MQTT local" />
<meta name="author" content="Aitor F." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Modificación del firmware de los switches wifi Sonoff para utilizarlos con un servidor MQTT local." />
<meta property="og:description" content="Modificación del firmware de los switches wifi Sonoff para utilizarlos con un servidor MQTT local." />
<link rel="canonical" href="https://kr0no.me/post/2017/01/reprogramar-sonoff-switch-mqtt" />
<meta property="og:url" content="https://kr0no.me/post/2017/01/reprogramar-sonoff-switch-mqtt" />
<meta property="og:site_name" content="kr0no.me" />
<meta property="og:image" content="https://kr0no.me/images/reprogramar-sonoff-switch-mqtt/sonoff.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://kr0no.me/images/reprogramar-sonoff-switch-mqtt/sonoff.jpg" />
<meta property="twitter:title" content="Reprogramando switch Sonoff para MQTT local" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Aitor F."},"description":"Modificación del firmware de los switches wifi Sonoff para utilizarlos con un servidor MQTT local.","image":"https://kr0no.me/images/reprogramar-sonoff-switch-mqtt/sonoff.jpg","url":"https://kr0no.me/post/2017/01/reprogramar-sonoff-switch-mqtt","@type":"BlogPosting","headline":"Reprogramando switch Sonoff para MQTT local","dateModified":"2017-01-27T00:00:00+00:00","datePublished":"2017-01-27T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kr0no.me/post/2017/01/reprogramar-sonoff-switch-mqtt"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <link rel="stylesheet" href="/assets/css/magnific-popup.css"><link type="application/atom+xml" rel="alternate" href="https://kr0no.me/feed.xml" title="kr0no.me" /><script src="https://code.jquery.com/jquery-3.2.0.min.js"></script> 
  <script src="/assets/js/jquery.magnific-popup.js"></script>
</head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">kr0no.me<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        
        
        <a class="color-cyan-hover" href="https://twitter.com/Aitor_FL"><i class="fab fa-twitter-square"></i></a>
        
        
        
        <a class="color-blue-hover" href="https://www.linkedin.com/in/aitorfl/"><i class="fab fa-linkedin"></i></a>
        
        
        
        <a class="color-purple-hover" href="https://github.com/kr0no"><i class="fab fa-github-square"></i></a>
        
        
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
  <div class="author-box">


<img src="
    /images/avatar.jpg
" class="author-avatar" alt="Avatar" />
<div class="description">Aitor Fuentes, a.k.a kr0no.<br /> En mis ratos libres, desarrollo videojuegos y cacharreo con cosas.<br /> Miembro del Red Team de Telefónica Tech.</div>

</div>


<div class="post">
  <h1 class="post-title">Reprogramando switch Sonoff para MQTT local</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/iot/">iot</a>
      
      <a class="tag" href="/tag/things/">things</a>
      
  </div>
  
  <div class="post-date">Published on 27 Jan 2017</div>
  
  <noscript>
    <div class="post-description">Modificación del firmware de los switches wifi Sonoff para utilizarlos con un servidor MQTT local.</div>
  </noscript>
  <div id="animated-post-description" class="post-description" style="display: none;"></div>
  
  <p>Los dispositivos Sonoff de ITead nos permiten crear una <em>“smart home”</em> con un coste realmente bajo y de forma muy sencilla, sin embargo, la gestión de estos dispositivos se hace a través de los propios servidores de Sonoff, por lo que estarán constanmente enviando y recibiendo las órdenes desde un lugar que no está bajo nuestro control, y mejor evitar esto, ¿no?</p>

<p>En este caso vamos a ver como reprogramar el <a href="https://www.itead.cc/smart-home/sonoff-wifi-wireless-switch.html">Sonoff Wifi Smart Switch</a>, (el cual tiene un coste de 4,85$ (~4,50€)) para que utilice nuestro propio servidor MQTT y todo se gestione desde nuestra red local.</p>

<p><img src="/images/reprogramar-sonoff-switch-mqtt/sonoff.jpg" alt="Switch Sonoff" /></p>

<p>Para poder reprogramar el dispositivo necesitaremos un adaptador USB a serial-TTL (yo utilizo <a href="https://www.amazon.es/gp/product/B01C2P9GD2">este</a>), y cuatro pines para soldarlos a la placa del switch.</p>

<p>Al lado del pulsador del switch hay cinco agujeros previstos para soldar una hilera de pines. Simplemente tendremos que soldar una hilera de cuatro pines en estos agujeros (el quinto no nos hace falta), tal y como está en la siguiente imagen:
<img src="/images/reprogramar-sonoff-switch-mqtt/pines2.png" alt="Pines" /></p>

<p>Una vez hecho esto tendremos que conectar el switch al adaptador USB serial-TTL de la siguiente forma:</p>
<ul>
  <li>El primer pin (empezamos por el que tenía el slot cuadrado, el más próximo al pulsador) a la salida 3,3v del adaptador USB.</li>
  <li>El segundo pin es RX, lo conectaremos al TX del adaptador.</li>
  <li>El tercer pin es TX, lo conectaremos al RX del adaptador.</li>
  <li>El cuarto pin es GND, lo conectaremos a un GND del adaptador.</li>
</ul>

<p>Una vez lo tengamos todo conectado, ya podemos pasar a programar el switch. Para encender el Sonoff en modo programación tendremos que mantener pulsado el pulsador antes de conectar el adaptador al PC.</p>

<p>Cuando al fin estemos en modo programación, podremos subir nuestro propio sketch al switch. La configuración para cargar correctamente el sketch en la placa es la siguiente:</p>
<ul>
  <li>Board: Generic ESP8266 Module</li>
  <li>Flash mode: DIO</li>
  <li>Flash size: 1M (64K SPIFFS)</li>
  <li>Reset method: ck</li>
</ul>

<p>Además necesitaremos usar un fork de la librería PubSubClient que tiene soporte para MQTT, disponible <a href="https://github.com/Imroy/pubsubclient">aquí</a>.</p>

<p>Tras estos pasos ya podremos cargar el nuevo sketch en la placa sin ningún problema:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
</pre></td><td class="code"><pre><span class="c1">//Based on a KmanOz work: https://github.com/KmanOz/Sonoff-HomeAssistant/blob/master/arduino/ESPsonoff-v1.01p/ESPsonoff-v1.01p.ino</span>

<span class="c1">//Needs PubSubClient with MQTT support: https://github.com/Imroy/pubsubclient</span>

<span class="cp">#include &lt;EEPROM.h&gt;
#include &lt;ESP8266WiFi.h&gt;
#include &lt;PubSubClient.h&gt;
#include &lt;Ticker.h&gt;
</span>
<span class="cp">#define BUTTON          0
#define RELAY           12
#define LED             13
</span>
<span class="cp">#define WIFI_SSID       "SSID"
#define WIFI_PASS       "PASSWORD"
</span>
<span class="cp">#define MQTT_CLIENT     "MQTT_CLIENT"
#define MQTT_SERVER     "MQTT_SERVER_IP"
#define MQTT_PORT       1883
#define MQTT_TOPIC      "mqtt/topic"
</span>
<span class="cp">#define MQTT_AUTH       true
#define MQTT_USER       "user"
#define MQTT_PASS       "pass"
</span>
<span class="c1">//logic</span>
<span class="kt">bool</span> <span class="n">sendStatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">restart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">lastState</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TTasks</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
  <span class="cp">#include "user_interface.h"
</span><span class="p">}</span>

<span class="n">WiFiClient</span> <span class="n">wifiClient</span><span class="p">;</span>
<span class="n">PubSubClient</span> <span class="nf">mqttClient</span><span class="p">(</span><span class="n">wifiClient</span><span class="p">,</span> <span class="n">MQTT_SERVER</span><span class="p">,</span> <span class="n">MQTT_PORT</span><span class="p">);</span>
<span class="n">Ticker</span> <span class="n">ticker</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="k">const</span> <span class="n">MQTT</span><span class="o">::</span><span class="n">Publish</span><span class="o">&amp;</span> <span class="n">pub</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">payload_string</span><span class="p">()</span> <span class="o">==</span> <span class="s">"stat"</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">payload_string</span><span class="p">()</span> <span class="o">==</span> <span class="s">"on"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">payload_string</span><span class="p">()</span> <span class="o">==</span> <span class="s">"off"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">payload_string</span><span class="p">()</span> <span class="o">==</span> <span class="s">"reset"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">sendStatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">BUTTON</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="n">EEPROM</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">lastState</span> <span class="o">=</span> <span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">lastState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">ticker</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">button</span><span class="p">);</span>
  <span class="n">mqttClient</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="n">WIFI_STA</span><span class="p">);</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASS</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"IP: "</span> <span class="o">+</span> <span class="n">WiFi</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
    <span class="k">if</span><span class="p">(</span><span class="n">MQTT_AUTH</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MQTT</span><span class="o">::</span><span class="n">Connect</span><span class="p">(</span><span class="n">MQTT_CLIENT</span><span class="p">).</span><span class="n">set_keepalive</span><span class="p">(</span><span class="mi">90</span><span class="p">).</span><span class="n">set_auth</span><span class="p">(</span><span class="n">MQTT_USER</span><span class="p">,</span> <span class="n">MQTT_PASS</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MQTT</span><span class="o">::</span><span class="n">Connect</span><span class="p">(</span><span class="n">MQTT_CLIENT</span><span class="p">).</span><span class="n">set_keepalive</span><span class="p">(</span><span class="mi">90</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">mqttClient</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">MQTT_TOPIC</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">RELAY</span><span class="p">)</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span>  <span class="p">{</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mqttClient</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="n">timedTasks</span><span class="p">();</span>
  <span class="n">checkStatus</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">button</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">BUTTON</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">count</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LED</span><span class="p">));</span>
      <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RELAY</span><span class="p">,</span> <span class="o">!</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">RELAY</span><span class="p">));</span>
      <span class="n">sendStatus</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">checkConnection</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mqttClient</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>    
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">checkStatus</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">sendStatus</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">LED</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOW</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">mqttClient</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">MQTT</span><span class="o">::</span><span class="n">Publish</span><span class="p">(</span><span class="n">MQTT_TOPIC</span><span class="s">"/stat"</span><span class="p">,</span> <span class="s">"on"</span><span class="p">).</span><span class="n">set_retain</span><span class="p">().</span><span class="n">set_qos</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">mqttClient</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">MQTT</span><span class="o">::</span><span class="n">Publish</span><span class="p">(</span><span class="n">MQTT_TOPIC</span><span class="s">"/stat"</span><span class="p">,</span> <span class="s">"off"</span><span class="p">).</span><span class="n">set_retain</span><span class="p">().</span><span class="n">set_qos</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">EEPROM</span><span class="p">.</span><span class="n">commit</span><span class="p">();</span>
    <span class="n">sendStatus</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ESP</span><span class="p">.</span><span class="n">restart</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">timedTasks</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">millis</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">TTasks</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60000</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">TTasks</span><span class="p">))</span> <span class="p">{</span> 
    <span class="n">TTasks</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="n">checkConnection</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Para terminar, reiniciaremos el switch para comprobar que se conecta automáticamente a la red wifi y al servidor MQTT indicados, quitándonos así los servidores de Sonoff de en medio :P</p>

<p>Si todo funciona correctamente, ya podemos conectarlo a la corriente alterna para darle el uso que teníamos previsto.</p>

</div>





<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/post/2016/10/usb-rubber-ducky-arduino">
            USB Rubber Ducky con Arduino UNO
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>blog tags</h2>
  <div class="tag-cloud"><a href="/tag/infosec/" class="set-1">infosec</a> <a href="/tag/iot/" class="set-1">iot</a> <a href="/tag/things/" class="set-5">things</a></div>
  




<script>
  let i = 0;
  const text = 'Modificación del firmware de los switches wifi Sonoff para utilizarlos con un servidor MQTT local.';
  const speed = parseInt('10');
  
  function typeWriter() {
    if (i < text.length) {
      document.getElementById('animated-post-description').innerHTML += text.charAt(i);
      i++;
      setTimeout(typeWriter, speed);
    }
  }

  document.getElementById('animated-post-description').style.display = 'initial';
  typeWriter();

  // Image modal
  var $imgs = [];
  $('img').each(function(idx) {
    var obj = {
      src: $(this).attr('src')
    }
    $imgs.push(obj);
    var elem = $(this);
    $(this).click(function() {
      $('.modal').magnificPopup('open', idx);
    });
  });

  $('.modal').magnificPopup({
    items: $imgs,
    type: 'image',
    closeOnContentClick: true,
    mainClass: 'mfp-img-mobile',
    image: {
      verticalFit: true
    }
    
  });
</script>

      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
    <div class="credits"><a href="https://github.com/bitbrain/jekyll-dash">dash</a> theme for Jekyll by <a href="https://github.com/bitbrain">bitbrain</a> made with <i class="fas fa-heart"></i><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');

if (theme === "light") {
    document.documentElement.setAttribute('data-theme', 'light');
} else {
    document.documentElement.setAttribute('data-theme', 'dark');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
